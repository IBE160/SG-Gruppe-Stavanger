<story-context id="docs/sprint-artifacts/4-2-mark-recipe-as-cooked-and-deduct-inventory.context.xml" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>2</storyId>
    <title>Mark Recipe as Cooked and Deduct Inventory</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-12-01</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/4-2-mark-recipe-as-cooked-and-deduct-inventory.md</sourceStoryPath>
  </metadata>
  <story>
    <asA>a user</asA>
    <iWant>to mark a recipe as cooked</iWant>
    <soThat>the used ingredients are automatically removed from my inventory.</soThat>
    <tasks>
        - Task: (AC: #1, #2, #3) Implement the "Mark as Cooked" functionality.
        - Subtask: Create the API endpoint `POST /api/recipes/{id}/cook` to handle the logic for deducting ingredients from the inventory.
        - Subtask: Develop the "Inventory Deduction Modal" component as specified in the UX design. This modal should list the ingredients of the recipe and allow the user to confirm their usage.
        - Subtask: Integrate the modal with the recipe details page, triggering it when the user clicks the "I Cooked This" button.
        - Subtask (Test): Write an integration test for the `POST /api/recipes/{id}/cook` endpoint to ensure it correctly updates inventory quantities in the database.
        - Subtask (Test): Write a component test for the "Inventory Deduction Modal" to verify its state management and user interactions.
        - Task: (AC: #1, #2, #3, E2E) Write an end-to-end test for the "Mark as Cooked" workflow.
        - Subtask (Test): The test should simulate a user viewing a recipe, marking it as cooked, confirming the ingredients in the modal, and then verifying that the inventory is correctly updated.
    </tasks>
  </story>
  <acceptanceCriteria>
    1.  When a user indicates they have cooked a recipe, the system prompts for confirmation of the ingredients used. (Source: epics.md#Story-4.2)
    2.  Upon confirmation, the quantities of the used ingredients are deducted from the user's inventory. (Source: epics.md#Story-4.2)
    3.  The inventory deduction is a deliberate, confirmed action, involving a modal confirmation step. (Source: epics.md#Story-4.2, ux-design-specification.md#Inventory-Deduction-Modal)
  </acceptanceCriteria>
  <artifacts>
    <docs>
        <doc>
            <path>docs/sprint-artifacts/tech-spec-epic-4.md</path>
            <title>Epic Technical Specification: Personalized Suggestions &amp; Alerts</title>
            <section>APIs and Interfaces</section>
            <snippet>Endpoint: POST /api/recipes/{id}/cook. Marks a recipe as cooked and deducts the used ingredients from the user's inventory.</snippet>
        </doc>
        <doc>
            <path>docs/PRD.md</path>
            <title>ibe160 - Product Requirements Document</title>
            <section>FR3.4 - Mark Recipe as Cooked</section>
            <snippet>A user can indicate they have cooked a recipe. The system prompts the user to confirm which ingredients from their inventory were used.</snippet>
        </doc>
        <doc>
            <path>docs/architecture.md</path>
            <title>Architecture</title>
            <section>API Contracts</section>
            <snippet>API Style: RESTful API. Implementation: Next.js API Routes (Route Handlers) for internal APIs.</snippet>
        </doc>
        <doc>
            <path>docs/ux-design-specification.md</path>
            <title>UX Design Specification</title>
            <section>Component Library / Custom/Key Components</section>
            <snippet>Inventory Deduction Modal: A custom modal to confirm ingredient deduction after cooking.</snippet>
        </doc>
        <doc>
            <path>docs/epics.md</path>
            <title>Epic Breakdown</title>
            <section>Epic 4: Personalized Suggestions &amp; Alerts / Story 4.2</section>
            <snippet>As a user, I want to mark a recipe as cooked, so that the used ingredients are automatically removed from my inventory. Technical Notes: Use POST /api/recipes/{id}/cook. Implement "Inventory Deduction Modal" custom component (per UX).</snippet>
        </doc>
    </docs>
    <code>
        <artifact>
            <path>app/api/recipes/[id]/cook/route.ts</path>
            <kind>api-route</kind>
            <symbol>POST</symbol>
            <lines>N/A (new file)</lines>
            <reason>Primary backend logic for this story will be implemented here.</reason>
        </artifact>
        <artifact>
            <path>app/(main)/recipes/[id]/page.tsx</path>
            <kind>ui-page</kind>
            <symbol>RecipePage</symbol>
            <lines>N/A</lines>
            <reason>This page will contain the "I Cooked This" button.</reason>
        </artifact>
        <artifact>
            <path>components/specific/InventoryDeductionModal.tsx</path>
            <kind>ui-component</kind>
            <symbol>InventoryDeductionModal</symbol>
            <lines>N/A (new file)</lines>
            <reason>This modal will be used to confirm ingredient deduction.</reason>
        </artifact>
    </code>
    <dependencies>
        <dependency>
            <name>next</name>
            <version>16+</version>
        </dependency>
        <dependency>
            <name>@supabase/supabase-js</name>
            <version>Latest Stable</version>
        </dependency>
    </dependencies>
  </artifacts>
  <constraints>
    - API Pattern: RESTful API using Next.js API Routes (Route Handlers)
    - Data Persistence: Supabase PostgreSQL will be updated.
    - Security: The API endpoint must be secured to ensure users can only modify their own inventory.
  </constraints>
  <interfaces>
    <interface>
      <name>POST /api/recipes/{id}/cook</name>
      <kind>REST endpoint</kind>
      <signature>POST /api/recipes/{id}/cook</signature>
      <path>app/api/recipes/[id]/cook/route.ts</path>
    </interface>
  </interfaces>
  <tests>
    <standards>Multi-layered strategy including Unit Tests (`Jest`, `React Testing Library`), Integration Tests (API routes, database interactions), and End-to-End (E2E) Tests (`Playwright`, `Cypress`), focusing on user-centric scenarios.</standards>
    <locations>
      - `tests/`
    </locations>
    <ideas>
        - (Integration) Test the `POST /api/recipes/{id}/cook` endpoint to ensure it correctly updates inventory quantities.
        - (Component) Test the "Inventory Deduction Modal" for its state management and user interactions.
        - (E2E) Simulate a user marking a recipe as cooked and verify that the inventory is correctly updated.
    </ideas>
  </tests>
</story-context>