<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.4</storyId>
    <title>User Login</title>
    <status>drafted</status>
    <generatedAt>2025-11-28</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-4-user-login.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a registered user</asA>
    <iWant>to log in with my email and password</iWant>
    <soThat>I can access my account</soThat>
    <tasks>
- [ ] **Task 1: Create Login UI** (AC: #1, #3)
  - [ ] Create the login page at `app/(auth)/login/page.tsx`.
  - [ ] Build the login form with email and password fields, and a submit button, following the UX design specification.
  - [ ] Implement client-side validation for the form fields.
  - [ ] Display user-friendly error messages for failed login attempts.
- [ ] **Task 2: Implement Login Logic** (AC: #1, #2)
  - [ ] Configure the NextAuth.js `CredentialsProvider` to use Supabase for authentication.
  - [ ] Implement the server-side logic to handle the login request, calling `supabase.auth.signInWithPassword()`.
  - [ ] On successful login, ensure NextAuth.js creates a session and redirects the user to `/dashboard`.
- [ ] **Task 3: Testing** (AC: #1, #2, #3)
  - [ ] Write unit tests for the login form component to verify rendering and validation.
  - [ ] Write an integration test for the NextAuth.js login flow with a mocked Supabase client.
  - [ ] Write an E2E test that simulates a user logging in and being redirected to the dashboard.
    </tasks>
  </story>

  <acceptanceCriteria>
1. A registered and verified user can log in successfully using their correct email and password. (Source: `docs/sprint-artifacts/tech-spec-epic-1.md`)
2. Upon successful login, the user is redirected to the application dashboard (`/dashboard`). (Source: `docs/sprint-artifacts/tech-spec-epic-1.md`)
3. If login fails due to incorrect credentials, a clear and user-friendly error message is displayed on the login form. (Source: `docs/sprint-artifacts/tech-spec-epic-1.md`)
  </acceptanceCriteria>

  <artifacts>
    <docs>
        <doc>
            <path>docs/architecture.md</path>
            <title>Architecture</title>
            <section>Authentication</section>
            <snippet>NextAuth.js with Supabase Auth | NextAuth.js 4.24.13 | User & Profile Management | Secure, flexible, and easy-to-implement authentication solution for Next.js, leveraging Supabase for backend user management.</snippet>
        </doc>
        <doc>
            <path>docs/PRD.md</path>
            <title>ibe160 - Product Requirements Document</title>
            <section>FR1.2 - User Login</section>
            <snippet>A registered user can log in using their email and password.</snippet>
        </doc>
        <doc>
            <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
            <title>Epic Technical Specification: Foundation & Core Setup</title>
            <section>Story 1.4: User Login (FR1.2)</section>
            <snippet>A registered and verified user can log in successfully using their correct email and password.</snippet>
        </doc>
        <doc>
            <path>docs/ux-design-specification.md</path>
            <title>ibe160 UX Design Specification</title>
            <section>1.1 Design System Choice</section>
            <snippet>The decision to use shadcn/ui is based on its perfect alignment with the project's core goals. Its "copy-paste" philosophy provides complete ownership and control over the UI components.</snippet>
        </doc>
    </docs>
    <code>
        <file>
            <path>lib/auth.ts</path>
            <kind>configuration</kind>
            <symbol>NextAuth.js config</symbol>
            <lines>N/A</lines>
            <reason>This file will contain the NextAuth.js configuration, including the CredentialsProvider for Supabase.</reason>
        </file>
        <file>
            <path>lib/supabaseClient.ts</path>
            <kind>client</kind>
            <symbol>Supabase client</symbol>
            <lines>N/A</lines>
            <reason>This file will contain the Supabase client initialization.</reason>
        </file>
    </code>
    <dependencies>
        <note>package.json not found. Project initialization (Story 1.1) appears to be incomplete.</note>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>All authentication and session management will be handled by NextAuth.js, leveraging the security features of Supabase Auth.</constraint>
    <constraint>Passwords will be securely hashed by Supabase Auth.</constraint>
    <constraint>All communication between the client, Next.js server, and Supabase will be over HTTPS.</constraint>
  </constraints>
  <interfaces>
    <interface>
        <name>/api/auth/login</name>
        <kind>REST endpoint</kind>
        <signature>POST /api/auth/login</signature>
        <path>app/api/auth/[...nextauth]/route.ts</path>
    </interface>
  </interfaces>
  <tests>
    <standards>Multi-layered strategy including Unit Tests (Jest, React Testing Library), Integration Tests (API routes, database interactions), and End-to-End (E2E) Tests (Playwright, Cypress), focusing on user-centric scenarios.</standards>
    <locations>
        - `tests/`
    </locations>
    <ideas>
        - E2E Test: A user logs in and is redirected. (AC: #1, #2)
        - Unit test for the login form component. (AC: #3)
        - Integration test for the NextAuth.js login flow.
    </ideas>
  </tests>
</story-context>